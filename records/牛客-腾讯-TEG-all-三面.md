## 来自牛客的部分三面面经

### 计费组
#### 1. 实习遇到的难题，如何解决？
可以讲ES宽表建设中对于局部有序性的问题。

##### 业务主键保证同一分区
把消息 key 设为业务主键（coupon_id / user_id / entitlement_id 等），并在消息中携带单调递增的版本字段（binlog commit_ts、binlog pos 或业务版本号）。

##### 在 ES 侧使用外部版本控制（简洁、靠 ES 保证幂等）
Elasticsearch 支持 version + version_type=external，消费者把 binlog 的增量 version（例如 commit_ts）作为版本号索引文档，ES 只会在外部版本比现有版本 大 时替换文档。

``` bash
PUT /coupons/_doc/{id}?version=1697623456000&version_type=external
{
  "id": "...",
  "amount": 100,
  "updated_at": "2025-10-17T12:34:16Z",
  ...
}

```

典型做法：消费者在接到消息后，先在轻量外部状态存储（比如 Redis）做原子比较并更新：只有当 incoming_version > stored_version 时才继续写 ES。用 Redis Lua 脚本保证比较+写入版本的原子性。

##### 外部轻量存储+计算
``` lua
-- KEYS[1] = "ver:entitlement:{id}"
-- ARGV[1] = incoming_version
local cur = redis.call("GET", KEYS[1])
if not cur or tonumber(ARGV[1]) > tonumber(cur) then
  redis.call("SET", KEYS[1], ARGV[1])
  return 1
end
return 0
```
消费流程：

1. 收到消息（id, version, payload）

2. 调 Redis Lua（比较并尝试写入版本）

3. 如果返回 1 → 写入 ES（普通 upsert 或 index）

3. 如果返回 0 → 丢弃或记录为过期消息

这个也同时需要做一些补偿
##### 外部轻量存储+服务段计算
redis缓存更新的时间，每次需要更新时，去redis中访问得到最新的快照时间，然后根据业务类型判断是否需要更新。


#### 2. 注册中心会遇到什么难点？
##### 服务注册与发现的延迟问题
- 问题：注册中心需要处理大量服务的注册与注销请求，尤其在大规模的微服务架构中，注册中心的负载会非常高。如果服务数量非常庞大，可能会出现服务注册与发现的延迟，影响服务间的通信和调用。

- 解决方案：采用高效的注册中心，如 Consul、etcd、Zookeeper，这些工具都具备高性能、高可用的特点，并且提供了心跳检测来确保服务健康状态。

##### 服务一致性问题
- 问题：在分布式环境下，注册中心需要确保服务数据的一致性。由于网络分区、节点故障等原因，可能会导致注册中心的数据不同步，甚至出现“服务丢失”的情况。

- 解决方案：可以采用 分布式一致性协议（如 Paxos 或 Raft）来保证注册中心的强一致性。比如 Zookeeper 就通过 ZAB（Zookeeper Atomic Broadcast）协议来保证数据一致性。

##### 注册中心的高可用性
- 问题：注册中心本身作为微服务架构的核心组件之一，如果注册中心宕机或无法访问，所有的服务发现和负载均衡功能都会受到影响，导致系统不可用。

- 解决方案：需要保证注册中心的高可用性，通常会使用 多节点部署、主备切换、故障转移 等方式，确保即使某个注册中心节点宕机，其他节点依然能够提供服务。

##### 口头回答版本
注册中心作为分布式系统中的关键组件，主要负责服务注册与发现。在实际应用中，可能会面临以下几个难点：

服务一致性：由于分布式系统的复杂性，注册中心需要保证服务注册信息的强一致性。在网络分区或节点宕机的情况下，如何确保数据一致性是一个挑战。使用分布式一致性协议，如 Raft 或 Paxos，可以有效保证这一点。

高可用性：注册中心的宕机会导致服务发现功能不可用，因此需要保证注册中心的高可用性。一般通过 多节点部署 和 故障转移 来确保系统的可靠性。

性能瓶颈：随着服务数量的增加，注册中心的负载可能会成为瓶颈，影响服务注册与发现的速度。为了解决这个问题，可以采用 分布式部署 和 数据分片 等策略来提升性能。

健康检查与服务下线：服务的健康状态需要实时监控，确保不可用的服务能够及时下线。通过 心跳机制 或 定期健康检查 来实现这一点，可以有效减少系统的故障传播。

总的来说，注册中心的设计和实现必须兼顾高可用性、一致性和性能，才能保证分布式系统的稳定运行。”

##### 结合CAP理论进行介绍
在理论计算机科学中，CAP 定理（CAP theorem）指出对于一个分布式系统来说，当设计读写操作时，只能同时满足以下三点中的两个：
- 一致性（Consistency） : 所有节点访问同一份最新的数据副本
- 可用性（Availability）: 非故障的节点在合理的时间内返回合理的响应（不是错误或者超时的响应）。
- 分区容错性（Partition Tolerance） : 分布式系统出现网络分区的时候，仍然能够对外提供服务。

##### 进一步发展

BASE 是 Basically Available（基本可用）、Soft-state（软状态） 和 Eventually Consistent（最终一致性） 三个短语的缩写。BASE 理论是对 CAP 中一致性 C 和可用性 A 权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于 CAP 定理逐步演化而来的，它大大降低了我们对系统的要求
- Basically Available（基本可用）：基本可用基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。但是，这绝不等价于系统不可用。什么叫允许损失部分可用性呢？响应时间上的损失: 正常情况下，处理用户请求需要 0.5s 返回结果，但是由于系统出现故障，处理用户请求的时间变为 3 s。系统功能上的损失：正常情况下，用户可以使用系统的全部功能，但是由于系统访问量突然剧增，系统的部分非核心功能无法使用。
- Soft-state（软状态）：软状态指允许系统中的数据存在中间状态（CAP 理论中的数据不一致），并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。
- 最终一致性：最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。

##### 一致性的不同等级
- 强一致性：系统写入了什么，读出来的就是什么。
- 弱一致性：不一定可以读取到最新写入的值，也不保证多少时间之后读取到的数据是最新的，只是会尽量保证某个时刻达到数据一致的状态。
- 最终一致性：弱一致性的升级版，系统会保证在一定时间内达到数据一致的状态。


#### 3. 服务熔断和降级如何考虑和实现的？

如何应对服务假死的问题？
C语言和Go了解吗？
给了一个C语言结构体，计算多少字节
介绍一下动态规划和回溯？
1，3，5面值的硬币若干，用上面两种算法分别口述思路。
回溯能否进一步剪枝？
算法题：符串压缩，写完问有没有比O(n)还好的算法。
实习时间，多久可以到岗？


### unknow1
1. 自我介绍
2. Redis 用于做什么
3. Redis 集群结构，哨兵选举流程
4. Zookeeper 底层是否了解，Zookeeper 选举流程
5. 交卷和阅卷功能为什么要用消息队列或线程池，流程设计思想
6. 如果线程池或者消息队列挂掉，怎么保证一定阅卷
7. 如果线程池或消息队列挂掉，此时用户又发出大量的查询请求，怎么保证服务不被冲垮掉
8. 有没有关注什么开源框架


### unknown2
KV 存储如何容错
Raft leader 选举
Raft 如何高可用
LSM tree 原理
正则表达式 * 和 ？的区别
环形链表有什么用
堆排序原理，和冒泡排序空间效率区别
UDP 和 TCP 的应用场景

### unknown3
1.用位运算判断奇偶数2.一个整数对1024取模
3.任意的m对n取模，不能用除法和取模
运算符
求m除n，保留k位小数，返回字符串形式
5.z字形矩阵生成
海量数据当中如何对敏感词过滤


### unknow4
1.自我介绍
2.一个涉及加密解密的项目，深挖，加密怎么做的，密钥怎么存的，前后端都问了，如何保证密钥的安全，如何生成的密钥，前端如何做的，如何检测证书等等问题
3.现在有一台服务器，一个DB实例，两张表，A表扣100块钱，B表加100块钱，如何实现事务，聊天框写一下，第一次写没有判断B是否余额够，第二次写了一半被叫停时间不够了。
4.两张表在不同的DB实例，涉及分布式事务，用的什么语言，业务层怎么实现线程同步的，除了信号量还有什么，锁，那就实现一下吧，写一下简单的代码
5.了解docker和k8s吗，用过，不太熟悉。
6.docker如何处理资源隔离的
7.k8s pod是什么
8.k8s pod和docker的容器什么关系
9.linux用过吗，如何创建子进程，如何监听进程，命名管道和无名管道的区别