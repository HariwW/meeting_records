### 问题1：实习的业务介绍一下，为什么要做这个项目？目前数据规模多少，优化后QPS，TP999从多少提升到多少。

ans: 数据规模不要说太低，9000w数据就实话就行，不然说太低面试官觉得你做的东西没必要

### 问题2：如何分析MySQL的负载情况和性能情况

ans：
#### 一、系统层面（操作系统、硬件资源）
先看 服务器资源是否够用，因为很多性能瓶颈其实不是 SQL 写得差，而是资源不够。

1、CPU：top、htop 看 CPU 使用率，主要关注 us（用户态）、sy（内核态）、wa（IO 等待）。如果 IO 等待高，说明磁盘压力大。

2、内存：看 free -h，确保 MySQL 的 buffer pool 足够大，避免频繁走磁盘。

3、磁盘 IO：iostat -x 1 查看磁盘的读写 IOPS、延迟。高延迟说明磁盘是瓶颈。

4、网络：如果是分布式架构，还要关注网卡带宽、丢包情况。

#### 二、数据库层面（MySQL 内部状态）
1. 查看总体负载情况
QPS（Queries Per Second）/ TPS（Transactions Per Second）
``` bash
SHOW GLOBAL STATUS LIKE 'Queries';
SHOW GLOBAL STATUS LIKE 'Com_commit';
SHOW GLOBAL STATUS LIKE 'Com_rollback';
```
连接情况
``` bash
SHOW PROCESSLIST;
```
线程池/连接数
``` bash
SHOW VARIABLES LIKE 'max_connections';
SHOW GLOBAL STATUS LIKE 'Threads_connected';
SHOW GLOBAL STATUS LIKE 'Threads_running';
```

2. 分析慢 SQL
``` bash
slow_query_log = ON
long_query_time = 1   # 大于 1 秒的 SQL 记录
log_queries_not_using_indexes = ON

```
分析工具：mysqldumpslow 或 pt-query-digest，聚合 SQL 模板，找到最消耗时间的 Top SQL。

3. 查看等待与锁情况
锁等待
```
SHOW ENGINE INNODB STATUS\G;
```
等待事件
``` bash
SELECT * FROM performance_schema.events_waits_summary_global_by_event_name
WHERE EVENT_NAME LIKE 'wait/io/file%';

```
4. 关键配置和缓存命中率
Buffer Pool 命中率
``` bash
SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_read%';

```
#### 三、排查 SQL 执行效率
看 SQL 是否走索引，是否有全表扫描，是否使用合适的索引。

EXPLAIN / EXPLAIN ANALYZE:看 SQL 是否走索引，是否有全表扫描，是否使用合适的索引。
索引分析:SHOW INDEX FROM table_name;
执行计划稳定性：注意统计信息是否过期，可能导致走错索引。

#### 四、监控工具（企业常用）

MySQL 自带
Performance Schema
Information Schema

开源监控
Prometheus + Grafana（最常见）
Percona Monitoring and Management (PMM)
Zabbix

商业/云服务
阿里云 RDS、腾讯云、AWS Aurora 等会内置 SQL 诊断。

#### 总结
总结一个排查步骤（面试/实际答法）：
系统资源：先看 CPU/内存/磁盘/网络是否瓶颈。

数据库负载：看 QPS/TPS、连接数、锁等待。

慢 SQL：打开慢日志，用 pt-query-digest 找出 Top SQL。

SQL 优化：用 EXPLAIN 检查索引、执行计划。

缓存与参数：检查 buffer pool 命中率、InnoDB 参数是否合理。

监控告警：接入 Grafana/PMM 做可视化，长期跟踪。

### 问题3：EXPLAIN SQL，如何分析索引的使用情况，如何让未生效的索引生效
一、常见导致索引不生效的原因 & 解决方法

字段运算或函数
SELECT * FROM user WHERE DATE(create_time) = '2025-08-28';
DATE(create_time) 让索引失效。
✅ 解决办法：把函数移到等号右边
SELECT * FROM user WHERE create_time >= '2025-08-28' AND create_time < '2025-08-29';


类型不匹配

SELECT * FROM user WHERE phone = 123456;   -- phone 是 varchar


隐式类型转换会导致索引失效。
✅ 解决办法：保持类型一致

SELECT * FROM user WHERE phone = '123456';


模糊查询（左模糊）

SELECT * FROM user WHERE name LIKE '%abc'; -- 索引失效


✅ 解决办法：改写为右模糊，或者用前缀索引/倒排索引

SELECT * FROM user WHERE name LIKE 'abc%';


复合索引未遵循最左前缀法则

INDEX(a,b,c)
SELECT * FROM t WHERE b=1;  -- 索引失效


必须从最左边开始匹配。
✅ 解决办法：调整 SQL 条件顺序，或增加单列索引。

OR 条件导致部分字段没用索引

SELECT * FROM user WHERE id=1 OR age=20;


可能会走全表扫描。
✅ 解决办法：拆分 SQL，用 UNION ALL。

数据分布问题

字段取值区分度太低（如性别只有 M/F），优化器可能判断走索引不划算，直接全表扫描。
✅ 解决办法：

给区分度高的字段建索引

或者用 组合索引 提升选择性

ORDER BY / GROUP BY 未命中索引

SELECT * FROM user ORDER BY age;


age 有索引但查询字段不在索引里 → 不能用覆盖索引，需要 filesort。
✅ 解决办法：建覆盖索引 (age, other_column) 或加 LIMIT。


#### 问题4：索引失效的场景有哪些
列上使用函数或表达式

SELECT * FROM t WHERE YEAR(date_col) = 2023;


函数作用在列上，索引失效。

优化：使用范围查询 WHERE date_col >= '2023-01-01' AND date_col < '2024-01-01'。

前置通配符的 LIKE

SELECT * FROM t WHERE name LIKE '%abc';


前面有 %，索引无法使用。

隐式类型转换

SELECT * FROM t WHERE int_col = '123';


列类型和常量类型不匹配，会触发类型转换，索引失效。

复合索引中间列未用、范围查询

CREATE INDEX idx_ab ON t(a, b);
SELECT * FROM t WHERE a > 5 AND b = 10;


在复合索引中，如果前面列是范围查询，后面的列索引可能失效。

OR 条件

SELECT * FROM t WHERE a = 1 OR b = 2;


单列索引可能无法完全使用，除非有覆盖索引或拆成 UNION。

NULL 值判断

SELECT * FROM t WHERE col IS NULL;


某些索引类型（尤其是 B+ 树）对 NULL 不一定优化。

更新频繁的列作为索引

虽然不是严格意义上的“失效”，频繁更新会导致索引性能下降。
#### 问题5：手撕SQL:用户表和订单表，2023消费金额前十的名字和总消费
原来写法：
``` sql
SELECT 
    u.user_name,
    SUM(o.amount) AS total_amount
FROM orders o
JOIN users u ON o.user_id = u.user_id
WHERE YEAR(o.order_date) = 2023
GROUP BY u.user_name
ORDER BY total_amount DESC
LIMIT 10;

```

#### 问题6：分析sql的性能，如何优化
改进写法
``` sql
SELECT 
    u.user_name,
    t.total_amount
FROM (
    SELECT 
        user_id, 
        SUM(amount) AS total_amount
    FROM orders
    WHERE order_date >= '2023-01-01' AND order_date < '2024-01-01'
    GROUP BY user_id
) t
JOIN users u ON t.user_id = u.user_id
ORDER BY t.total_amount DESC
LIMIT 10;
```



#### 问题6：lc最大子数组和