# 计算机网络
## 一、OSI模型
### 1. 物理层
实现相邻节点之间比特的传输

包含如下功能：
1. 需定义电路接口参数(如:形状、尺寸、引脚数等)
2. 需定义传输信号的含义、电气特征(如:5V表示1，1V表示0;每比特电信持续时间0.1ms)

### 2.链路层
确保相邻节点之间的链路逻辑上没有差错，以帧的形式进行传播

包含如下功能：

1. 差错控制：检错+纠错，或者检错+丢弃+重传
2. 流量控制：协调两个节点的速率


### 3. 网络层
把分组从源节点转发到目标节点，以分组Packet的形式进行传播

包含如下功能：
1. 路由选择：维护并构造路由表，决定分组到达目标节点的最佳路径
2. 分组转发：将“分组”从合适的端口转发出去
3. 拥塞控制：发现网络拥塞，并采取措施缓解拥塞
4. 网际互联：实现异构网络互联
5. 其他功能：差错控制，流量控制，连接建立和释放，可靠传输管理
   
### 4.传输层
实现端到端的通信，端指端口以报文段的形式进行传播

包含如下功能：
1. 复用和分用：发送端几个高层实体复用一条低层的额连接，在接收端进行分用
2. 其他功能：差错控制，流量控制，连接建立和释放，可靠传输管理

### 会话层，表示层，应用层
以报文的形式进行传播

会话层：管理进程之间的会话

表示层：解决不同主机信息表示不一致的问题

应用层：实现特定的网络应用

## 二、TCP/IP模型
### 1. 物理层

### 2. 数据链路层

整体思路如下：
![alt text](../../figs/image-network-datalinklayer.png)

#### 组帧

主要问题：

1. 帧定界
2. 透明传输

解决方法：

1. 字符计数法
2. 字节填充法：SOH和EOT
3. 零比特填充法：每次遇到5个1就填个0
4. 违规编码法：帧前后加违规的时钟信号

#### 差错控制
检错：
1. 奇数偶数校验法，增加校验位添加01（偶数校验用异或实现）
2. 循环冗余校验码
纠错：
海明码

#### 流量控制，可靠传输和滑动窗口
- 流量控制
1. 停止-等待协议（Stop-and-Wait ARQ）

    发送窗口 = 1，接收窗口 = 1

    发送方每次只能发送一个数据帧，必须等待该帧的确认（ACK）后才能发送下一个。

    接收方接收到第 i 个帧后，若检测无误，返回 ACK(i)；若超时未收到 ACK，发送方重传该帧。

    由于一次仅发送一帧，因此只需要 1 bit 帧编号（0/1交替使用）。

2. 后退 N 帧协议（Go-Back-N ARQ）

    发送窗口 > 1，接收窗口 = 1

    发送方可以连续发送多个数据帧（最多 N 个），无需等待每帧的确认。

    接收方只按序接收数据帧：

    若收到第 i 帧无误，则返回累积确认 ACK(i)。

    若中间某个帧出错或丢失，则从该帧开始的所有后续帧都被丢弃。

    确认可以 累积确认，即连续接收多个数据帧，只需返回最后一个 ACK。

    若发送方在定时器超时前未收到相应 ACK，则从出错帧开始 重传所有未确认的帧。

    帧编号使用 k bit，编号范围为 0 ～ 2^k − 1。

3. 选择重传协议（Selective Repeat ARQ）

    发送窗口 > 1，接收窗口 > 1

    发送方可以连续发送多个帧，接收方也可以 缓存乱序到达的帧。

    接收方对每个正确接收的帧分别返回 ACK(i)，若某帧出错，仅要求重传该帧。

    因此，发送方只需 选择性重传出错或丢失的帧，无需重传后续所有帧。

    接收方在缓存中可暂存已正确接收但未按序交付的帧，待缺失帧补齐后按序交付给上层。

    帧编号使用 k bit，为了避免确认混淆，发送窗口和接收窗口的大小均为 2^(k−1)。

总结对比如下：
| 协议名称   | 发送窗口 | 接收窗口 | 确认方式 | 出错处理        | 效率 |
| ------ | ---- | ---- | ---- | ----------- | -- |
| 停止-等待  | 1    | 1    | 每帧确认 | 重传当前帧       | 最低 |
| 后退 N 帧 | >1   | 1    | 累积确认 | 出错后重传所有未确认帧 | 较高 |
| 选择重传   | >1   | >1   | 个别确认 | 仅重传出错帧      | 最高 |

#### CSMA CD协议

先听后发，边听边发，冲突停发，随机重发

#### CSMA CA协议
针对WIFI的场景，不能使用CSMA/CD协议，主要是不能监听，所以就要用CA(avoid)协议
![alt text](../../figs\image-network-CSMA-CA.png)

信道预约，发送控制帧来预约哪个时间被占用![alt text](image.png)

#### 令牌传递协议
令牌传递协议（Token Passing） 是一种 轮流访问介质的控制协议。
它通过在网络节点之间传递一个特殊的控制帧——“令牌（Token）”，
来控制哪个节点可以发送数据，从而避免冲突。

#### MAC层帧内容
![alt text](../../figs\image-network-MACdata.png)

#### VLAN

VLAN 可以把一个物理局域网（LAN）划分为多个逻辑局域网，使得同一物理网络中的不同用户之间像是分属于不同的网络。
``` diff
+-------------------------------+
| 目标MAC | 源MAC | VLAN标记 | 数据 | CRC |
+-------------------------------+
```

#### 以太网交换机
普通二层交换机在转发用户流量时不使用自己的 MAC 地址，

但它拥有 MAC 地址（通常一个或多个），用于设备管理或三层转发功能。

交换机（Switch） 是一种在数据链路层（OSI 第二层）工作的网络设备，用于根据 MAC 地址 转发以太网帧。

它通过构建并维护一张 MAC 地址表（MAC Address Table / CAM Table） 来实现高效的数据帧转发。

| 特点          | 说明                            |
| ----------- | ----------------------------- |
| **工作层次**    | 数据链路层（第二层），有些高端交换机支持第三层（路由功能） |
| **主要作用**    | 根据目标 MAC 地址转发帧，实现局域网内部通信      |
| **转发效率高**   | 采用硬件电路（ASIC）实现转发，比软件路由快       |
| **自学习能力**   | 能自动学习端口与 MAC 地址对应关系           |
| **隔离冲突域**   | 每个端口独立成为一个冲突域，提高带宽利用率         |
| **不隔离广播域**  | 所有端口仍属于同一广播域（除非划分 VLAN）       |
| **支持全双工通信** | 可实现同时发送和接收，无需 CSMA/CD 协议      |

### 3. 网络层
#### IP数据报的内容
``` diff
+------------------------------------------------------------+
| 版本 | 首部长度 | 服务类型 |         总长度                 |
+------------------------------------------------------------+
|            标识              |标志位|    片偏移                |
+------------------------------------------------------------+
| 生存时间 | 协议类型 |       首部校验和                   |
+------------------------------------------------------------+
|                    源 IP 地址                              |
+------------------------------------------------------------+
|                    目的 IP 地址                            |
+------------------------------------------------------------+
|        可选字段 + 填充（如有）                            |
+------------------------------------------------------------+
|                     数据部分（Payload）                    |
+------------------------------------------------------------+

```
#### 子网划分和子网掩码
子网是把一个大的 IP 网络再划分成多个更小的网络。

子网掩码是一种 32 位的数，用来区分“网络号”和“主机号”。
#### CIDR

CIDR（Classless Inter-Domain Routing，无类别域间路由）是为了解决传统 IP 地址分类（A/B/C 类）带来的地址浪费问题而提出的一种 IP 地址分配与路由聚合机制。

CIDR = 灵活划分网络 + 路由聚合机制（减少路由表项，可能会引入无用地址），
通过使用“IP地址/前缀长度”表示网络，
有效节省了地址空间并优化了路由表结构。

#### 最长匹配原则

转发到匹配最长的地址

#### NAT协议
